<!DOCTYPE html>
<html>
<head>
    <title>Mapbox GL JS debug page</title>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel='stylesheet' href='../dist/mapbox-gl.css' />
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.2.2/mapbox-gl-draw.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.2.2/mapbox-gl-draw.css' type='text/css' />
    <script src='https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 0; }
        html, body, #map { height: 100%; }
        .measure-move {
            background-color: white;
            border-radius: 3px;
            height: 16px;
            line-height: 16px;
            padding: 0 3px;
            font-size: 12px;
            box-shadow: 0 0 0 1px #ccc;
            float: right;
            cursor: default;
        }

        .measure-result {
            background-color: white;
            border-radius: 3px;
            height: 16px;
            line-height: 16px;
            padding: 0 3px;
            font-size: 12px;
            box-shadow: 0 0 0 1px #ccc;
            float: right;
            cursor: default;
            z-index: 10;
        }

        .close {
            width: 3px;
            height: 14px;
            text-align: center;
            border-radius: 3px;
            padding-top: 0px;
            padding-right: 10px;
            box-shadow: 0 0 0 0px #ccc;
            cursor: pointer;
            background: url(./res/close.png) no-repeat center;
            border: 1px solid rgba(100, 100, 100, 0)
        }

        .clear {
            width: 3px;
            height: 14px;
            text-align: center;
            border-radius: 3px;
            padding-right: 10px;
            box-shadow: 0 0 0 0px #ccc;
            cursor: pointer;
            float: right;
            background: url(./res/delete.png) no-repeat center;
            border: 1px solid rgba(100, 100, 100, 0)
        }


        .close:hover {
            border: 1px solid rgba(52, 98, 152, 1);
        }

        .clear:hover {
            border: 1px solid rgba(52, 98, 152, 1);
        }

        .edit:hover {
            border: 1px solid rgba(52, 98, 152, 1);
        }
        #btn {
            position: absolute;
            top: 50px;
            left: 50px;
        }

    </style>
</head>

<body>
<div id='map'></div>
<div id="btn">
    <button onclick="measureDistance()">距离</button>
    <button onclick="measureArea()">面积</button>
    <button onclick="measureAreaRect()">矩形面积</button>
    <button onclick="measureAzimuth()">方位角</button>
    <button onclick="measureAngle()">角度量测</button>
    <button onclick="measureGPS()">坐标测量</button>
    <button onclick="clearAll()">清理</button>
</div>
<script src='../dist/mapbox-gl-dev.js'></script>
<script src='../debug/access_token_generated.js'></script>
<script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
<script>
    class MeatureTool {
        map = void 0
        constructor(Map) {
            this.map = Map
        }

        layerList = []

        /**
         * 测量距离
         * @param {*} layerId
         */
        measureDistance(layerId) {
            this.layerList.push(layerId)
            let isMeasure = true;
            const map = this.map
            map.doubleClickZoom.disable()
            let catchMark = null

            const jsonPoint = {
                type: 'FeatureCollection',
                features: [],
            }
            const jsonLine = {
                type: 'FeatureCollection',
                features: [],
            }

            // 添加测量结果弹窗
            const ele = document.createElement('div')
            ele.setAttribute('class', 'measure-move')
            const option = {
                element: ele,
                anchor: 'left',
                offset: [8, 0],
            }
            const tooltip = new mapboxgl.Marker(option).setLngLat([0, 0]).addTo(map)

            // 添加测量图层
            map.addSource('points' + layerId, {
                type: 'geojson',
                data: jsonPoint,
            })
            map.addSource('point-move' + layerId, {
                type: 'geojson',
                data: jsonPoint,
            })
            map.addSource('line' + layerId, {
                type: 'geojson',
                data: jsonLine,
            })
            map.addSource('line-move' + layerId, {
                type: 'geojson',
                data: jsonLine,
            })
            map.addSource('point-follow' + layerId, {
                type: 'geojson',
                data: jsonPoint,
            })
            map.addLayer({
                id: 'line' + layerId,
                type: 'line',
                source: 'line' + layerId,
                paint: {
                    'line-color': '#ff0000',
                    'line-width': 2,
                    'line-opacity': 0.65,
                },
            })
            map.addLayer({
                id: 'line-move' + layerId,
                type: 'line',
                source: 'line-move' + layerId,
                paint: {
                    'line-color': '#ff0000',
                    'line-width': 2,
                    'line-opacity': 0.65,
                    'line-dasharray': [5, 2],
                },
            })
            map.addLayer({
                id: 'points' + layerId,
                type: 'circle',
                source: 'points' + layerId,
                paint: {
                    'circle-color': '#ffffff',
                    'circle-radius': 3.5,
                    'circle-stroke-width': 1.5,
                    'circle-stroke-color': '#ff0000',
                },
            })
            map.addLayer({
                id: 'point-move' + layerId,
                type: 'circle',
                source: 'point-move' + layerId,
                paint: {
                    'circle-color': '#ffffff',
                    'circle-radius': 3.5,
                    'circle-stroke-width': 1.5,
                    'circle-stroke-color': '#ff0000',
                },
            })
            // 活动点可以选择用图层，也可以选择用Mark
            map.addLayer({
                id: 'point-follow' + layerId,
                type: 'circle',
                source: 'point-follow' + layerId,
                paint: {
                    'circle-color': '#199afc',
                    'circle-radius': 5.5,
                    'circle-stroke-width': 1.5,
                    'circle-stroke-color': '#ffffff',
                },
            })

            /**
             * 添加点
             * @param {*} _e
             */
            function addPointforJSON(_e) {
                if (isMeasure) {
                    const point = {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [_e.lngLat.lng, _e.lngLat.lat],
                        },
                        properties: {
                            id: String(new Date().getTime()),
                        },
                    }
                    jsonPoint.features.push(point)
                    map.getSource('points' + layerId).setData(jsonPoint)
                    drawLine(jsonPoint)
                    addMeasureRes(jsonPoint)
                }
            }

            /**
             * 绘制线
             * @param {*} jsonPoint
             */
            function drawLine(jsonPoint) {
                if (jsonPoint.features.length > 1) {
                    jsonLine.features = []
                    for (let i = 0; i < jsonPoint.features.length - 1; i++) {
                        const coords = jsonPoint.features[i].geometry.coordinates
                        const next_coords = jsonPoint.features[i + 1].geometry.coordinates
                        jsonLine.features.push({
                            type: 'Feature',
                            geometry: {
                                type: 'LineString',
                                coordinates: [coords, next_coords],
                            },
                        })
                    }
                    map.getSource('line' + layerId).setData(jsonLine)
                }
            }

            /**
             * 添加dom
             * @param {*} jsonPoint 点集
             */
            function addMeasureRes(jsonPoint) {
                if (jsonPoint.features.length > 0) {
                    removedom()
                    const pointList = []
                    for (let i = 0; i < jsonPoint.features.length; i++) {
                        const coords = jsonPoint.features[i].geometry.coordinates
                        pointList.push(coords)

                        const close = document.createElement('div')
                        close.setAttribute('class', `measure-result ${layerId} close`)
                        close.onclick = (__e) => {
                            // 移除点
                            __e.stopPropagation()
                            removePoint(coords)
                            map.off('mousedown', onmousedown)
                            if (catchMark) {
                                catchMark.remove()
                            }
                        }

                        const clear = document.createElement('div')
                        clear.setAttribute('class', `measure-result ${layerId} clear`)
                        clear.onclick = (__e) => {
                            // 全部删除
                            __e.stopPropagation()
                            removeLayer()
                            map.off('mousedown', onmousedown)
                            if (catchMark) {
                                catchMark.remove()
                            }
                        }

                        const element = document.createElement('div')
                        element.setAttribute('class', 'measure-result ' + layerId)
                        const option = {
                            element: element,
                            anchor: 'left',
                            offset: [8, 0],
                        }
                        element.innerHTML = i === 0 ? '起点' : getLength(pointList)
                        if ((jsonPoint.features.length === i + 1) & !isMeasure) {
                            element.appendChild(clear)
                        }
                        element.appendChild(close)
                        new mapboxgl.Marker(option).setLngLat(coords).addTo(map)
                    }
                }
            }

            /**
             * 移除点
             * @param {*} coords 点坐标
             */
            function removePoint(coords) {
                if (jsonPoint.features.length > 0) {
                    if (jsonPoint.features.length === 2) {
                        jsonPoint.features = []
                        jsonLine.features = []
                        map.getSource('points' + layerId).setData(jsonPoint)
                        map.getSource('line' + layerId).setData(jsonLine)
                        removedom()
                    } else {
                        for (let i = 0; i < jsonPoint.features.length; i++) {
                            if (
                                (jsonPoint.features[i].geometry.coordinates[0] === coords[0]) &
                                (jsonPoint.features[i].geometry.coordinates[1] === coords[1])
                            ) {
                                jsonPoint.features.splice(i, 1)
                            }
                        }
                        drawLine(jsonPoint)
                        addMeasureRes(jsonPoint)
                        map.getSource('points' + layerId).setData(jsonPoint)
                    }
                }
            }

            /**
             * 计算长度
             * @param {*} pointList
             * @returns
             */
            function getLength(pointList) {
                const line = turf.lineString(pointList)
                let len = turf.length(line)
                if (len < 1) {
                    len = Math.round(len * 1000) + '米'
                } else {
                    len = len.toFixed(2) + '公里'
                }
                return len
            }

            /**
             * 移除dom
             */
            function removedom() {
                const dom = document.getElementsByClassName('measure-result ' + layerId)
                const len = dom.length
                if (len) {
                    for (let i = len - 1; i >= 0; i--) {
                        if (dom[i]) dom[i].remove()
                    }
                }
            }

            /**
             * 移除图层
             */
            function removeLayer() {
                jsonPoint.features = []
                jsonLine.features = []
                map.removeLayer('points' + layerId)
                map.removeLayer('line' + layerId)
                removedom()
            }

            /**
             * 鼠标move事件
             * @param {} _e
             */
            function mouseMove(_e) {
                if (isMeasure) {
                    map.getCanvas().style.cursor = 'default'
                    var coords = [_e.lngLat.lng, _e.lngLat.lat]
                    const jsonp = {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: coords,
                        },
                    }
                    map.getSource('point-move' + layerId).setData(jsonp)

                    if (jsonPoint.features.length > 0) {
                        const pointList = []
                        for (let i = 0; i < jsonPoint.features.length; i++) {
                            const coord = jsonPoint.features[i].geometry.coordinates
                            pointList.push(coord)
                        }
                        pointList.push(coords)
                        const prev = jsonPoint.features[jsonPoint.features.length - 1]
                        const jsonl = {
                            type: 'Feature',
                            geometry: {
                                type: 'LineString',
                                coordinates: [prev.geometry.coordinates, coords],
                            },
                        }
                        map.getSource('line-move' + layerId).setData(jsonl)
                        ele.innerHTML = getLength(pointList)
                        tooltip.setLngLat(coords)
                    }
                }
            }

            /**
             * 绘制完成
             * @param {*} _e
             */
            function finish(_e) {
                if (isMeasure) {
                    isMeasure = false
                    const coords = [_e.lngLat.lng, _e.lngLat.lat];
                    removePoint(coords)
                    map.removeLayer('point-move' + layerId)
                    map.removeLayer('line-move' + layerId)
                    map.getCanvas().style.cursor = 'default'
                    tooltip.remove()
                }
            }

            map.on('click', function (_e) {
                addPointforJSON(_e)
            })

            map.on('mousemove', function (_e) {
                mouseMove(_e)
            })

            map.on('dblclick', function (_e) {
                finish(_e)
            })
        }

        /**
         * 测量面积
         * @param {*} layerId
         */
        measureArea(layerId) {
            this.layerList.push(layerId)
            var isMeasure = true
            const map = this.map
            map.doubleClickZoom.disable()
            let catchMark = null

            const jsonPoint = {
                type: 'FeatureCollection',
                features: [],
            }
            const jsonLine = {
                type: 'FeatureCollection',
                features: [],
            }

            const ele = document.createElement('div')
            ele.setAttribute('class', 'measure-move')
            const option = {
                element: ele,
                anchor: 'left',
                offset: [8, 0],
            }
            const tooltip = new mapboxgl.Marker(option).setLngLat([0, 0]).addTo(map)

            map.addSource('points-area' + layerId, {
                type: 'geojson',
                data: jsonPoint,
            })
            map.addSource('point-move' + layerId, {
                type: 'geojson',
                data: jsonPoint,
            })
            map.addSource('line-area' + layerId, {
                type: 'geojson',
                data: jsonLine,
            })
            map.addSource('line-move' + layerId, {
                type: 'geojson',
                data: jsonLine,
            })
            map.addLayer({
                id: 'line-move' + layerId,
                type: 'line',
                source: 'line-move' + layerId,
                paint: {
                    'line-color': '#ff0000',
                    'line-width': 2,
                    'line-opacity': 0.65,
                    'line-dasharray': [5, 2],
                },
            })
            map.addLayer({
                id: 'line-area' + layerId,
                type: 'fill',
                source: 'line-area' + layerId,
                paint: {
                    'fill-color': '#ff0000',
                    'fill-opacity': 0.1,
                },
            })
            map.addLayer({
                id: 'line-area-stroke' + layerId,
                type: 'line',
                source: 'line-area' + layerId,
                paint: {
                    'line-color': '#ff0000',
                    'line-width': 2,
                    'line-opacity': 0.65,
                },
            })
            map.addLayer({
                id: 'points-area' + layerId,
                type: 'circle',
                source: 'points-area' + layerId,
                paint: {
                    'circle-color': '#ffffff',
                    'circle-radius': 3.5,
                    'circle-stroke-width': 1.5,
                    'circle-stroke-color': '#ff0000',
                },
            })
            map.addLayer({
                id: 'point-move' + layerId,
                type: 'circle',
                source: 'point-move' + layerId,
                paint: {
                    'circle-color': '#ffffff',
                    'circle-radius': 3.5,
                    'circle-stroke-width': 1.5,
                    'circle-stroke-color': '#ff0000',
                },
            })

            /**
             * 添加点
             * @param {*} _e
             */
            function addPointforJSON(_e) {
                if (isMeasure) {
                    const point = {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [_e.lngLat.lng, _e.lngLat.lat],
                        },
                        properties: {
                            id: String(new Date().getTime()),
                        },
                    }
                    jsonPoint.features.push(point)
                    map.getSource('points-area' + layerId).setData(jsonPoint)
                    addMeasureRes(jsonPoint)
                }
            }

            /**
             * 添加dom
             * @param {*} jsonPoint 点集
             */
            function addMeasureRes(jsonPoint) {
                if (jsonPoint.features.length > 0) {
                    removedom()
                    const pointList = []
                    for (let i = 0; i < jsonPoint.features.length; i++) {
                        const coords = jsonPoint.features[i].geometry.coordinates
                        pointList.push(coords)

                        const close = document.createElement('div')
                        close.setAttribute('class', `measure-result ${layerId} close`)
                        close.onclick = (__e) => {
                            // 移除点
                            __e.stopPropagation()
                            removePoint(coords)
                            map.off('mousedown', onmousedown)
                            if (catchMark) {
                                catchMark.remove()
                            }
                        }
                        if ((jsonPoint.features.length === i + 1) & !isMeasure) {
                            const clear = document.createElement('div')
                            clear.setAttribute('class', `measure-result ${layerId} clear`)
                            clear.onclick = (__e) => {
                                // 全部移除
                                __e.stopPropagation()
                                removeLayer()
                                map.off('mousedown', onmousedown)
                                if (catchMark) {
                                    catchMark.remove()
                                }
                            }

                            const element = document.createElement('div')
                            element.setAttribute('class', 'measure-result ' + layerId)
                            const option = {
                                element: element,
                                anchor: 'left',
                                offset: [0, 0],
                            }
                            element.innerHTML = getArea(pointList)
                            element.appendChild(clear)
                            element.appendChild(close)
                            new mapboxgl.Marker(option).setLngLat(coords).addTo(map)
                        } else {
                            const option = {
                                element: close,
                                anchor: 'left',
                                offset: [5, -15],
                            }
                            new mapboxgl.Marker(option).setLngLat(coords).addTo(map)
                        }
                    }
                }
            }

            /**
             * 计算面积
             * @param {*} pointList
             * @returns
             */
            function getArea(pointList) {
                pointList.push(pointList[0])
                const polygon = turf.polygon([pointList])
                let area = turf.area(polygon)
                if (area < 10000) {
                    area = Math.round(area) + '平方米'
                } else {
                    area = (area / 1000000).toFixed(2) + '平方公里'
                }
                return area
            }

            /**
             * 移除点
             * @param {*} coords 点坐标
             */
            function removePoint(coords) {
                if (jsonPoint.features.length > 0) {
                    if (jsonPoint.features.length === 3) {
                        jsonPoint.features = []
                        jsonLine.features = []
                        map.getSource('points-area' + layerId).setData(jsonPoint)
                        map.getSource('line-area' + layerId).setData(jsonLine)
                        removedom()
                    } else {
                        for (let i = 0; i < jsonPoint.features.length; i++) {
                            if (
                                (jsonPoint.features[i].geometry.coordinates[0] === coords[0]) &
                                (jsonPoint.features[i].geometry.coordinates[1] === coords[1])
                            ) {
                                jsonPoint.features.splice(i, 1)
                            }
                        }
                        addMeasureRes(jsonPoint)
                        map.getSource('points-area' + layerId).setData(jsonPoint)

                        const pointList = []
                        for (let i = 0; i < jsonPoint.features.length; i++) {
                            const coord = jsonPoint.features[i].geometry.coordinates
                            pointList.push(coord)
                        }
                        const pts = pointList.concat([pointList[0]])
                        const jsona = {
                            type: 'Feature',
                            geometry: {
                                type: 'Polygon',
                                coordinates: [pts],
                            },
                        }
                        map.getSource('line-area' + layerId).setData(jsona)
                    }
                }
            }

            /**
             * 移除dom
             */
            function removedom() {
                const dom = document.getElementsByClassName('measure-result ' + layerId)
                const len = dom.length
                if (len) {
                    for (let i = len - 1; i >= 0; i--) {
                        if (dom[i]) dom[i].remove()
                    }
                }
            }

            /**
             * 移除图层
             */
            function removeLayer() {
                jsonPoint.features = []
                jsonLine.features = []
                map.removeLayer('points-area' + layerId)
                map.removeLayer('line-area' + layerId)
                map.removeLayer('line-area-stroke' + layerId)
                removedom()
            }

            /**
             * 鼠标move事件
             * @param {} _e
             */
            function mouseMove(_e) {
                if (isMeasure) {
                    map.getCanvas().style.cursor = 'default'
                    const coords = [_e.lngLat.lng, _e.lngLat.lat]
                    const jsonp = {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: coords,
                        },
                    }
                    map.getSource('point-move' + layerId).setData(jsonp)

                    if (jsonPoint.features.length > 0) {
                        if (jsonPoint.features.length === 1) {
                            const prev = jsonPoint.features[jsonPoint.features.length - 1]
                            const jsonl = {
                                type: 'Feature',
                                geometry: {
                                    type: 'LineString',
                                    coordinates: [prev.geometry.coordinates, coords],
                                },
                            }
                            map.getSource('line-move' + layerId).setData(jsonl)
                        } else {
                            const json = {
                                type: 'FeatureCollection',
                                features: [],
                            }
                            map.getSource('line-move' + layerId).setData(json)

                            const pointList = []
                            for (let i = 0; i < jsonPoint.features.length; i++) {
                                const coord = jsonPoint.features[i].geometry.coordinates
                                pointList.push(coord)
                            }
                            pointList.push(coords)
                            const pts = pointList.concat([pointList[0]])
                            const jsona = {
                                type: 'Feature',
                                geometry: {
                                    type: 'Polygon',
                                    coordinates: [pts],
                                },
                            }
                            map.getSource('line-area' + layerId).setData(jsona)
                            ele.innerHTML = getArea(pointList)
                            tooltip.setLngLat(coords)
                        }
                    }
                }
            }

            /**
             * 绘制完成
             * @param {*} _e
             */
            function finish(_e) {
                if (isMeasure) {
                    isMeasure = false
                    const coords = [_e.lngLat.lng, _e.lngLat.lat]
                    removePoint(coords)
                    map.removeLayer('point-move' + layerId)
                    map.removeLayer('line-move' + layerId)
                    map.getCanvas().style.cursor = 'default'
                    tooltip.remove()
                }
            }

            map.on('click', function (_e) {
                addPointforJSON(_e)
            })

            map.on('dblclick', function (_e) {
                finish(_e)
            })

            map.on('mousemove', function (_e) {
                mouseMove(_e)
            })

        }

        /**
         * 测量矩形面积
         * @param {*} layerId
         */
        measureAreaRect(layerId) {
            this.layerList.push(layerId)
            var isMeasure = true
            const map = this.map
            map.doubleClickZoom.disable()
            let catchMark = null

            const jsonPoint = {
                type: 'FeatureCollection',
                features: [],
            }
            const jsonLine = {
                type: 'FeatureCollection',
                features: [],
            }

            const ele = document.createElement('div')
            ele.setAttribute('class', 'measure-move')
            const option = {
                element: ele,
                anchor: 'left',
                offset: [8, 0],
            }
            const tooltip = new mapboxgl.Marker(option).setLngLat([0, 0]).addTo(map)

            map.addSource('points-area' + layerId, {
                type: 'geojson',
                data: jsonPoint,
            })
            map.addSource('point-move' + layerId, {
                type: 'geojson',
                data: jsonPoint,
            })
            map.addSource('line-area' + layerId, {
                type: 'geojson',
                data: jsonLine,
            })
            map.addSource('line-move' + layerId, {
                type: 'geojson',
                data: jsonLine,
            })
            map.addLayer({
                id: 'line-move' + layerId,
                type: 'line',
                source: 'line-move' + layerId,
                paint: {
                    'line-color': '#ff0000',
                    'line-width': 2,
                    'line-opacity': 0.65,
                    'line-dasharray': [5, 2],
                },
            })
            map.addLayer({
                id: 'line-area' + layerId,
                type: 'fill',
                source: 'line-area' + layerId,
                paint: {
                    'fill-color': '#ff0000',
                    'fill-opacity': 0.1,
                },
            })
            map.addLayer({
                id: 'line-area-stroke' + layerId,
                type: 'line',
                source: 'line-area' + layerId,
                paint: {
                    'line-color': '#ff0000',
                    'line-width': 2,
                    'line-opacity': 0.65,
                },
            })
            map.addLayer({
                id: 'points-area' + layerId,
                type: 'circle',
                source: 'points-area' + layerId,
                paint: {
                    'circle-color': '#ffffff',
                    'circle-radius': 3.5,
                    'circle-stroke-width': 1.5,
                    'circle-stroke-color': '#ff0000',
                },
            })
            map.addLayer({
                id: 'point-move' + layerId,
                type: 'circle',
                source: 'point-move' + layerId,
                paint: {
                    'circle-color': '#ffffff',
                    'circle-radius': 3.5,
                    'circle-stroke-width': 1.5,
                    'circle-stroke-color': '#ff0000',
                },
            })

            /**
             * 添加点
             * @param {*} _e
             */
            function addPointforJSON(_e) {
                if (isMeasure) {
                    const point = {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [_e.lngLat.lng, _e.lngLat.lat],
                        },
                        properties: {
                            id: String(new Date().getTime()),
                        },
                    }
                    jsonPoint.features.push(point)
                    map.getSource('points-area' + layerId).setData(jsonPoint)
                    addMeasureRectRes(jsonPoint)
                }
            }

            /**
             * 添加dom
             * @param {*} jsonPoint 点集
             */
            function addMeasureRectRes(jsonPoint) {
                if (jsonPoint.features.length > 0) {
                    removedom()
                    const pointList = []
                    for (let i = 0; i < jsonPoint.features.length; i++) {

                    }
                    if ((jsonPoint.features.length === 2) ) {
                        const start = jsonPoint.features[0].geometry.coordinates
                        const end = jsonPoint.features[1].geometry.coordinates
                        pointList.push(start)
                        pointList.push([start[0],end[1]])
                        pointList.push(end)
                        pointList.push([end[0],start[1]])
                        const clear = document.createElement('div')
                        clear.setAttribute('class', `measure-result ${layerId} clear`)
                        clear.onclick = (__e) => {
                            // 全部移除
                            __e.stopPropagation()
                            removeLayer()
                            map.off('mousedown', onmousedown)
                            if (catchMark) {
                                catchMark.remove()
                            }
                        }

                        const element = document.createElement('div')
                        element.setAttribute('class', 'measure-result ' + layerId)
                        const option = {
                            element: element,
                            anchor: 'left',
                            offset: [0, 0],
                        }
                        element.innerHTML = getArea(pointList)
                        element.appendChild(clear)
                        new mapboxgl.Marker(option).setLngLat(jsonPoint.features[jsonPoint.features.length-1].geometry.coordinates).addTo(map)
                        finish()
                    }
                }
            }

            /**
             * 计算面积
             * @param {*} pointList
             * @returns
             */
            function getArea(pointList) {
                pointList.push(pointList[0])
                const polygon = turf.polygon([pointList])
                let area = turf.area(polygon)
                if (area < 10000) {
                    area = Math.round(area) + '平方米'
                } else {
                    area = (area / 1000000).toFixed(2) + '平方公里'
                }
                return area
            }

            /**
             * 移除点
             * @param {*} coords 点坐标
             */
            function removePoint(coords) {
                if (jsonPoint.features.length > 0) {
                    if (jsonPoint.features.length === 3) {
                        jsonPoint.features = []
                        jsonLine.features = []
                        map.getSource('points-area' + layerId).setData(jsonPoint)
                        map.getSource('line-area' + layerId).setData(jsonLine)
                        removedom()
                    } else {
                        for (let i = 0; i < jsonPoint.features.length; i++) {
                            if (
                                (jsonPoint.features[i].geometry.coordinates[0] === coords[0]) &
                                (jsonPoint.features[i].geometry.coordinates[1] === coords[1])
                            ) {
                                jsonPoint.features.splice(i, 1)
                            }
                        }
                        addMeasureRes(jsonPoint)
                        map.getSource('points-area' + layerId).setData(jsonPoint)

                        const pointList = []
                        for (let i = 0; i < jsonPoint.features.length; i++) {
                            const coord = jsonPoint.features[i].geometry.coordinates
                            pointList.push(coord)
                        }
                        const pts = pointList.concat([pointList[0]])
                        const jsona = {
                            type: 'Feature',
                            geometry: {
                                type: 'Polygon',
                                coordinates: [pts],
                            },
                        }
                        map.getSource('line-area' + layerId).setData(jsona)
                    }
                }
            }

            /**
             * 移除dom
             */
            function removedom() {
                const dom = document.getElementsByClassName('measure-result ' + layerId)
                const len = dom.length
                if (len) {
                    for (let i = len - 1; i >= 0; i--) {
                        if (dom[i]) dom[i].remove()
                    }
                }
            }

            /**
             * 移除图层
             */
            function removeLayer() {
                jsonPoint.features = []
                jsonLine.features = []
                map.removeLayer('points-area' + layerId)
                map.removeLayer('line-area' + layerId)
                map.removeLayer('line-area-stroke' + layerId)
                removedom()
            }

            /**
             * 鼠标move事件
             * @param {} _e
             */
            function mouseMove(_e) {
                if (isMeasure) {
                    map.getCanvas().style.cursor = 'default'
                    const coords = [_e.lngLat.lng, _e.lngLat.lat]
                    const jsonp = {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: coords,
                        },
                    }
                    map.getSource('point-move' + layerId).setData(jsonp)

                    if (jsonPoint.features.length > 0) {
                        // if (jsonPoint.features.length === 1) {
                        //     const prev = jsonPoint.features[jsonPoint.features.length - 1]
                        //     const jsonl = {
                        //         type: 'Feature',
                        //         geometry: {
                        //             type: 'LineString',
                        //             coordinates: [prev.geometry.coordinates, coords],
                        //         },
                        //     }
                        //     map.getSource('line-move' + layerId).setData(jsonl)
                        // } else
                        {
                            const json = {
                                type: 'FeatureCollection',
                                features: [],
                            }
                            map.getSource('line-move' + layerId).setData(json)

                            const pointList = []
                            const start = jsonPoint.features[0].geometry.coordinates
                            pointList.push(start)
                            pointList.push([start[0],coords[1]])
                            pointList.push(coords)
                            pointList.push([coords[0],start[1]])
                            const pts = pointList.concat([pointList[0]])
                            const jsona = {
                                type: 'Feature',
                                geometry: {
                                    type: 'Polygon',
                                    coordinates: [pts],
                                },
                            }
                            map.getSource('line-area' + layerId).setData(jsona)
                            ele.innerHTML = getArea(pointList)
                            tooltip.setLngLat(coords)

                        }
                    }
                }
            }

            /**
             * 绘制完成
             * @param {*} _e
             */
            function finish() {
                if (isMeasure) {
                    isMeasure = false
                    // const coords = [_e.lngLat.lng, _e.lngLat.lat]
                    // removePoint(coords)
                    map.removeLayer('point-move' + layerId)
                    map.removeLayer('line-move' + layerId)
                    map.getCanvas().style.cursor = 'default'
                    tooltip.remove()
                }
            }

            map.on('click', function (_e) {
                addPointforJSON(_e)
            })

            map.on('dblclick', function (_e) {
                finish(_e)
            })

            map.on('mousemove', function (_e) {
                mouseMove(_e)
            })

        }

        /**
         * 测量方位角
         * @param {*} layerId
         */
        measureAzimuth(layerId) {
            this.layerList.push(layerId)
            let isMeasure = true;
            const map = this.map
            map.doubleClickZoom.disable()
            let catchMark = null

            const jsonPoint = {
                type: 'FeatureCollection',
                features: [],
            }
            const jsonLine = {
                type: 'FeatureCollection',
                features: [],
            }
            const jsonArrow = {
                type: 'FeatureCollection',
                features: [],
            }

            // 添加测量结果弹窗
            const ele = document.createElement('div')
            ele.setAttribute('class', 'measure-move')
            const option = {
                element: ele,
                anchor: 'left',
                offset: [8, 0],
            }
            const tooltip = new mapboxgl.Marker(option).setLngLat([0, 0]).addTo(map)

            // 添加测量图层
            map.addSource('points' + layerId, {
                type: 'geojson',
                data: jsonPoint,
            })
            map.addSource('point-move' + layerId, {
                type: 'geojson',
                data: jsonPoint,
            })
            map.addSource('line' + layerId, {
                type: 'geojson',
                data: jsonLine,
            })
            map.addSource('lineArrow' + layerId, {
                type: 'geojson',
                data: jsonArrow,
            })
            map.addSource('line-move' + layerId, {
                type: 'geojson',
                data: jsonLine,
            })
            map.addSource('point-follow' + layerId, {
                type: 'geojson',
                data: jsonPoint,
            })

            map.addLayer({
                id: 'line' + layerId,
                type: 'line',
                source: 'line' + layerId,
                paint: {
                    'line-color': '#ff0000',
                    'line-width': 2,
                    'line-opacity': 0.65,
                },
            })

            map.addLayer({
                id: 'lineArrow' + layerId,
                type: 'line',
                source: 'lineArrow' + layerId,
                paint: {
                    'line-color': '#ff0000',
                    'line-width': 2,
                    'line-opacity': 0.65,
                },
            })

            map.addLayer({
                id: 'line-move' + layerId,
                type: 'line',
                source: 'line-move' + layerId,
                paint: {
                    'line-color': '#ff0000',
                    'line-width': 2,
                    'line-opacity': 0.65,
                    'line-dasharray': [5, 2],
                },
            })

            map.addLayer({
                id: 'points' + layerId,
                type: 'circle',
                source: 'points' + layerId,
                paint: {
                    'circle-color': '#ffffff',
                    'circle-radius': 3.5,
                    'circle-stroke-width': 1.5,
                    'circle-stroke-color': '#ff0000',
                },
            })
            map.addLayer({
                id: 'point-move' + layerId,
                type: 'circle',
                source: 'point-move' + layerId,
                paint: {
                    'circle-color': '#ffffff',
                    'circle-radius': 3.5,
                    'circle-stroke-width': 1.5,
                    'circle-stroke-color': '#ff0000',
                },
            })
            // 活动点可以选择用图层，也可以选择用Mark
            map.addLayer({
                id: 'point-follow' + layerId,
                type: 'circle',
                source: 'point-follow' + layerId,
                paint: {
                    'circle-color': '#199afc',
                    'circle-radius': 5.5,
                    'circle-stroke-width': 1.5,
                    'circle-stroke-color': '#ffffff',
                },
            })


            /**
             * 添加点
             * @param {*} _e
             */
            function addPointforJSON(_e) {
                if (isMeasure) {
                    const point = {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [_e.lngLat.lng, _e.lngLat.lat],
                        },
                        properties: {
                            id: String(new Date().getTime()),
                        },
                    }
                    jsonPoint.features.push(point)
                    map.getSource('points' + layerId).setData(jsonPoint)
                    drawLine(jsonPoint)

                    // 添加箭头
                    var length = jsonPoint.features.length;
                    if(length===2){
                        var end = jsonPoint.features[length - 1 ].geometry.coordinates;
                        var preEnd = jsonPoint.features[length - 2 ].geometry.coordinates;
                        var bearing = turf.bearing(preEnd, end);

                        var arrowLength = 0.05;
                        var arrowAngle = 20;
                        var leftWing = turf.destination(end, arrowLength, bearing - 180 + arrowAngle);
                        var rightWing = turf.destination(end, arrowLength, bearing - 180 - arrowAngle);
                        const pointLeftWing = {
                            type: 'Feature',
                            geometry: {
                                type: 'Point',
                                coordinates: leftWing.geometry.coordinates,
                            },
                            properties: {
                                id: String(new Date().getTime()),
                            },
                        }
                        jsonArrow.features.push(pointLeftWing)
                        const pointEnd = {
                            type: 'Feature',
                            geometry: {
                                type: 'Point',
                                coordinates: end,
                            },
                            properties: {
                                id: String(new Date().getTime()),
                            },
                        }
                        jsonArrow.features.push(pointEnd)
                        const pointRightWing = {
                            type: 'Feature',
                            geometry: {
                                type: 'Point',
                                coordinates: rightWing.geometry.coordinates,
                            },
                            properties: {
                                id: String(new Date().getTime()),
                            },
                        }
                        jsonArrow.features.push(pointRightWing)

                        drawLineArrow(jsonArrow)
                    }

                    addMeasureRes(jsonPoint)
                }
            }

            /**
             * 绘制线
             * @param {*} jsonPoint
             */
            function drawLine(jsonPoint) {
                if (jsonPoint.features.length > 1) {
                    jsonLine.features = []
                    for (let i = 0; i < jsonPoint.features.length - 1; i++) {
                        const coords = jsonPoint.features[i].geometry.coordinates
                        const next_coords = jsonPoint.features[i + 1].geometry.coordinates
                        jsonLine.features.push({
                            type: 'Feature',
                            geometry: {
                                type: 'LineString',
                                coordinates: [coords, next_coords],
                            },
                        })
                    }
                    map.getSource('line' + layerId).setData(jsonLine)
                }
            }

            /**
             * 绘制箭头
             * @param {*} jsonPoint
             */
            function drawLineArrow(jsonPoint) {
                if (jsonPoint.features.length > 1) {
                    jsonLine.features = []
                    for (let i = 0; i < jsonPoint.features.length - 1; i++) {
                        const coords = jsonPoint.features[i].geometry.coordinates
                        const next_coords = jsonPoint.features[i + 1].geometry.coordinates
                        jsonLine.features.push({
                            type: 'Feature',
                            geometry: {
                                type: 'LineString',
                                coordinates: [coords, next_coords],
                            },
                        })
                    }
                    map.getSource('lineArrow' + layerId).setData(jsonLine)
                }
            }

            /**
             * 添加dom
             * @param {*} jsonPoint 点集
             */
            function addMeasureRes(jsonPoint) {
                if (jsonPoint.features.length === 2) {
                    debugger
                    removedom()
                    const pointList = []
                    for (let i = 0; i < jsonPoint.features.length; i++) {
                        const coords = jsonPoint.features[i].geometry.coordinates
                        pointList.push(coords)
                    }
                   if(jsonPoint.features.length ===2){
                       const clear = document.createElement('div')
                       clear.setAttribute('class', `measure-result ${layerId} clear`)
                       clear.onclick = (__e) => {
                           // 全部删除
                           __e.stopPropagation()
                           removeLayer()
                           map.off('mousedown', onmousedown)
                           if (catchMark) {
                               catchMark.remove()
                           }
                       }


                       if(jsonPoint.features.length ===2 &&pointList.length === 2){
                           const element = document.createElement('div')
                           element.setAttribute('class', 'measure-result ' + layerId)
                           const option = {
                               element: element,
                               anchor: 'left',
                               offset: [8, 0],
                           }
                           element.innerHTML =  getAzimuth(pointList)
                           element.appendChild(clear)
                       new mapboxgl.Marker(option).setLngLat(jsonPoint.features[jsonPoint.features.length-1].geometry.coordinates).addTo(map)
                       }
                       finish()
                   }
                }
            }

            /**
             * 计算长度
             * @param {*} pointList
             * @returns
             */
            function getAzimuth(pointList) {
              const angle = getAngleHandle(...pointList.flat())
                let text =angle.toFixed(2)+'°'
                return text
            }

            /**
             * 获取两点位之间的角度
             * @param lng1
             * @param lat1
             * @param lng2
             * @param lat2
             * @returns {number}
             */
            function getAngleHandle (lng1, lat1, lng2, lat2) {
                const a = (90 - lat2) * Math.PI / 180
                const b = (90 - lat1) * Math.PI / 180
                const AOC_BOC = (lng2 - lng1) * Math.PI / 180
                const cosc = Math.cos(a) * Math.cos(b) + Math.sin(a) * Math.sin(b) * Math.cos(AOC_BOC)
                const sinc = Math.sqrt(1 - cosc * cosc)
                const sinA = Math.sin(a) * Math.sin(AOC_BOC) / sinc
                const A = Math.asin(sinA) * 180 / Math.PI
                let res = 0
                if (lng2 > lng1 && lat2 > lat1) {
                    res = A
                } else if (lng2 > lng1 && lat2 < lat1) {
                    res = 180 - A
                } else if (lng2 < lng1 && lat2 < lat1) {
                    res = 180 - A
                } else if (lng2 < lng1 && lat2 > lat1) {
                    res = 360 + A
                } else if (lng2 > lng1 && lat2 === lat1) {
                    res = 90
                } else if (lng2 < lng1 && lat2 === lat1) {
                    res = 270
                } else if (lng2 === lng1 && lat2 > lat1) {
                    res = 0
                } else if (lng2 === lng1 && lat2 < lat1) {
                    res = 180
                }
                return res
            }

            /**
             * 移除dom
             */
            function removedom() {
                const dom = document.getElementsByClassName('measure-result ' + layerId)
                const len = dom.length
                if (len) {
                    for (let i = len - 1; i >= 0; i--) {
                        if (dom[i]) dom[i].remove()
                    }
                }
            }

            /**
             * 移除图层
             */
            function removeLayer() {
                jsonPoint.features = []
                jsonLine.features = []
                map.removeLayer('points' + layerId)
                map.removeLayer('line' + layerId)
                map.removeLayer('lineArrow' + layerId)
                removedom()
            }

            /**
             * 鼠标move事件
             * @param {} _e
             */
            function mouseMove(_e) {
                if (isMeasure) {
                    map.getCanvas().style.cursor = 'default'
                    var coords = [_e.lngLat.lng, _e.lngLat.lat]
                    const jsonp = {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: coords,
                        },
                    }
                    map.getSource('point-move' + layerId).setData(jsonp)

                    if (jsonPoint.features.length > 1) {
                        const pointList = []
                        for (let i = 0; i < jsonPoint.features.length; i++) {
                            const coord = jsonPoint.features[i].geometry.coordinates
                            pointList.push(coord)
                        }
                        pointList.push(coords)
                        const prev = jsonPoint.features[jsonPoint.features.length - 1]
                        const jsonl = {
                            type: 'Feature',
                            geometry: {
                                type: 'LineString',
                                coordinates: [prev.geometry.coordinates, coords],
                            },
                        }
                        map.getSource('line-move' + layerId).setData(jsonl)
                        ele.innerHTML = getAzimuth(pointList)
                        tooltip.setLngLat(coords)
                    }
                }
            }

            /**
             * 绘制完成
             * @param {*} _e
             */
            function finish() {
                if (isMeasure) {
                    isMeasure = false
                    map.removeLayer('point-move' + layerId)
                    map.removeLayer('line-move' + layerId)
                    map.getCanvas().style.cursor = 'default'
                    tooltip.remove()
                }
            }

            map.on('click', function (_e) {
                addPointforJSON(_e)
            })

            map.on('mousemove', function (_e) {
                mouseMove(_e)
            })
        }

        /**
         * 角度量测
         * @param {*} layerId
         */
        measureAngle(layerId) {
            this.layerList.push(layerId)
            let isMeasure = true;
            const map = this.map
            map.doubleClickZoom.disable()
            let catchMark = null

            const jsonPoint = {
                type: 'FeatureCollection',
                features: [],
            }
            const jsonLine = {
                type: 'FeatureCollection',
                features: [],
            }

            // 添加测量结果弹窗
            const ele = document.createElement('div')
            ele.setAttribute('class', 'measure-move')
            const option = {
                element: ele,
                anchor: 'left',
                offset: [8, 0],
            }
            const tooltip = new mapboxgl.Marker(option).setLngLat([0, 0]).addTo(map)

            // 添加测量图层
            map.addSource('points' + layerId, {
                type: 'geojson',
                data: jsonPoint,
            })
            map.addSource('point-move' + layerId, {
                type: 'geojson',
                data: jsonPoint,
            })
            map.addSource('line' + layerId, {
                type: 'geojson',
                data: jsonLine,
            })
            map.addSource('line-move' + layerId, {
                type: 'geojson',
                data: jsonLine,
            })
            map.addSource('point-follow' + layerId, {
                type: 'geojson',
                data: jsonPoint,
            })

            map.addLayer({
                id: 'line' + layerId,
                type: 'line',
                source: 'line' + layerId,
                paint: {
                    'line-color': '#ff0000',
                    'line-width': 2,
                    'line-opacity': 0.65,
                },
            })

            map.addLayer({
                id: 'line-move' + layerId,
                type: 'line',
                source: 'line-move' + layerId,
                paint: {
                    'line-color': '#ff0000',
                    'line-width': 2,
                    'line-opacity': 0.65,
                    'line-dasharray': [5, 2],
                },
            })

            map.addLayer({
                id: 'points' + layerId,
                type: 'circle',
                source: 'points' + layerId,
                paint: {
                    'circle-color': '#ffffff',
                    'circle-radius': 3.5,
                    'circle-stroke-width': 1.5,
                    'circle-stroke-color': '#ff0000',
                },
            })
            map.addLayer({
                id: 'point-move' + layerId,
                type: 'circle',
                source: 'point-move' + layerId,
                paint: {
                    'circle-color': '#ffffff',
                    'circle-radius': 3.5,
                    'circle-stroke-width': 1.5,
                    'circle-stroke-color': '#ff0000',
                },
            })
            // 活动点可以选择用图层，也可以选择用Mark
            map.addLayer({
                id: 'point-follow' + layerId,
                type: 'circle',
                source: 'point-follow' + layerId,
                paint: {
                    'circle-color': '#199afc',
                    'circle-radius': 5.5,
                    'circle-stroke-width': 1.5,
                    'circle-stroke-color': '#ffffff',
                },
            })


            /**
             * 添加点
             * @param {*} _e
             */
            function addPointforJSON(_e) {
                if (isMeasure) {
                    const point = {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [_e.lngLat.lng, _e.lngLat.lat],
                        },
                        properties: {
                            id: String(new Date().getTime()),
                        },
                    }
                    jsonPoint.features.push(point)
                    map.getSource('points' + layerId).setData(jsonPoint)
                    drawLine(jsonPoint)



                    addMeasureRes(jsonPoint)
                }
            }

            /**
             * 绘制线
             * @param {*} jsonPoint
             */
            function drawLine(jsonPoint) {
                if (jsonPoint.features.length > 1) {
                    jsonLine.features = []
                    for (let i = 0; i < jsonPoint.features.length - 1; i++) {
                        const coords = jsonPoint.features[i].geometry.coordinates
                        const next_coords = jsonPoint.features[i + 1].geometry.coordinates
                        jsonLine.features.push({
                            type: 'Feature',
                            geometry: {
                                type: 'LineString',
                                coordinates: [coords, next_coords],
                            },
                        })
                    }
                    map.getSource('line' + layerId).setData(jsonLine)
                }
            }

            /**
             * 添加dom
             * @param {*} jsonPoint 点集
             */
            function addMeasureRes(jsonPoint) {
                if (jsonPoint.features.length === 3) {
                    removedom()
                    const pointList = []
                    for (let i = 0; i < jsonPoint.features.length; i++) {
                        const coords = jsonPoint.features[i].geometry.coordinates
                        pointList.push(coords)
                    }
                        const clear = document.createElement('div')
                        clear.setAttribute('class', `measure-result ${layerId} clear`)
                        clear.onclick = (__e) => {
                            // 全部删除
                            __e.stopPropagation()
                            removeLayer()
                            map.off('mousedown', onmousedown)
                            if (catchMark) {
                                catchMark.remove()
                            }
                        }


                        if(jsonPoint.features.length ===3 && pointList.length === 3){
                            const element = document.createElement('div')
                            element.setAttribute('class', 'measure-result ' + layerId)
                            const option = {
                                element: element,
                                anchor: 'left',
                                offset: [8, 0],
                            }
                            element.innerHTML =  getAngle(pointList)
                            element.appendChild(clear)
                            new mapboxgl.Marker(option).setLngLat(jsonPoint.features[jsonPoint.features.length-2].geometry.coordinates).addTo(map)
                        }
                        finish()
                }
            }

            /**
             * 计算长度
             * @param {*} pointList
             * @returns
             */
            function getAngle(pointList) {
                const angle = angleBetweenThreePoints(...pointList.flat())
                let text =angle.toFixed(2)+'°'
                return text
            }

            function toRadians(degrees) {
                return degrees * Math.PI / 180;
            }

            function latLngToCartesian(lon, lat) {
                const latRad = toRadians(lat);
                const lonRad = toRadians(lon);
                const x = Math.cos(latRad) * Math.cos(lonRad);
                const y = Math.cos(latRad) * Math.sin(lonRad);
                const z = Math.sin(latRad);
                return [x, y, z];
            }

            function dotProduct(vector1, vector2) {
                return vector1[0] * vector2[0] + vector1[1] * vector2[1] + vector1[2] * vector2[2];
            }

            function magnitude(vector) {
                return Math.sqrt(vector[0] * vector[0] + vector[1] * vector[1] + vector[2] * vector[2]);
            }

            function angleBetweenThreePoints(lon1, lat1, lon2, lat2, lon3, lat3) {
                const p1 = latLngToCartesian(lon1, lat1);
                const p2 = latLngToCartesian(lon2, lat2);
                const p3 = latLngToCartesian(lon3, lat3);

                const v1 = [p1[0] - p2[0], p1[1] - p2[1], p1[2] - p2[2]];
                const v2 = [p3[0] - p2[0], p3[1] - p2[1], p3[2] - p2[2]];

                const dotProd = dotProduct(v1, v2);
                const magV1 = magnitude(v1);
                const magV2 = magnitude(v2);

                const angleRad = Math.acos(dotProd / (magV1 * magV2));
                const angleDeg = angleRad * 180 / Math.PI;

                return angleDeg;
            }

            /**
             * 移除dom
             */
            function removedom() {
                const dom = document.getElementsByClassName('measure-result ' + layerId)
                const len = dom.length
                if (len) {
                    for (let i = len - 1; i >= 0; i--) {
                        if (dom[i]) dom[i].remove()
                    }
                }
            }

            /**
             * 移除图层
             */
            function removeLayer() {
                jsonPoint.features = []
                jsonLine.features = []
                map.removeLayer('points' + layerId)
                map.removeLayer('line' + layerId)
                removedom()
            }

            /**
             * 鼠标move事件
             * @param {} _e
             */
            function mouseMove(_e) {
                if (isMeasure) {
                    map.getCanvas().style.cursor = 'default'
                    var coords = [_e.lngLat.lng, _e.lngLat.lat]
                    const jsonp = {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: coords,
                        },
                    }
                    map.getSource('point-move' + layerId).setData(jsonp)

                    if (jsonPoint.features.length > 2) {
                        const pointList = []
                        for (let i = 0; i < jsonPoint.features.length; i++) {
                            const coord = jsonPoint.features[i].geometry.coordinates
                            pointList.push(coord)
                        }
                        pointList.push(coords)
                        const prev = jsonPoint.features[jsonPoint.features.length - 1]
                        const jsonl = {
                            type: 'Feature',
                            geometry: {
                                type: 'LineString',
                                coordinates: [prev.geometry.coordinates, coords],
                            },
                        }
                        map.getSource('line-move' + layerId).setData(jsonl)
                        ele.innerHTML = getAngle(pointList)
                        tooltip.setLngLat(prev.geometry.coordinates)
                    }
                }
            }

            /**
             * 绘制完成
             * @param {*} _e
             */
            function finish() {
                if (isMeasure) {
                    isMeasure = false
                    map.removeLayer('point-move' + layerId)
                    map.removeLayer('line-move' + layerId)
                    map.getCanvas().style.cursor = 'default'
                    tooltip.remove()
                }
            }

            map.on('click', function (_e) {
                addPointforJSON(_e)
            })

            map.on('mousemove', function (_e) {
                mouseMove(_e)
            })
        }

        /**
         * 坐标测量
         * @param {*} layerId
         */
        measureGPS(layerId) {
            this.layerList.push(layerId)
            let isMeasure = true;
            const map = this.map
            map.doubleClickZoom.disable()
            let catchMark = null

            const jsonPoint = {
                type: 'FeatureCollection',
                features: [],
            }

            // 添加测量结果弹窗
            const ele = document.createElement('div')
            ele.setAttribute('class', 'measure-move')
            const option = {
                element: ele,
                anchor: 'left',
                offset: [8, 0],
            }
            const tooltip = new mapboxgl.Marker(option).setLngLat([0, 0]).addTo(map)

            // 添加测量图层
            map.addSource('points' + layerId, {
                type: 'geojson',
                data: jsonPoint,
            })
            map.addSource('point-move' + layerId, {
                type: 'geojson',
                data: jsonPoint,
            })
            map.addSource('point-follow' + layerId, {
                type: 'geojson',
                data: jsonPoint,
            })
            map.addLayer({
                id: 'points' + layerId,
                type: 'circle',
                source: 'points' + layerId,
                paint: {
                    'circle-color': '#ffffff',
                    'circle-radius': 3.5,
                    'circle-stroke-width': 1.5,
                    'circle-stroke-color': '#ff0000',
                },
            })
            map.addLayer({
                id: 'point-move' + layerId,
                type: 'circle',
                source: 'point-move' + layerId,
                paint: {
                    'circle-color': '#ffffff',
                    'circle-radius': 3.5,
                    'circle-stroke-width': 1.5,
                    'circle-stroke-color': '#ff0000',
                },
            })
            // 活动点可以选择用图层，也可以选择用Mark
            map.addLayer({
                id: 'point-follow' + layerId,
                type: 'circle',
                source: 'point-follow' + layerId,
                paint: {
                    'circle-color': '#199afc',
                    'circle-radius': 5.5,
                    'circle-stroke-width': 1.5,
                    'circle-stroke-color': '#ffffff',
                },
            })

            /**
             * 添加点
             * @param {*} _e
             */
            function addPointforJSON(_e) {
                if (isMeasure) {
                    const point = {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [_e.lngLat.lng, _e.lngLat.lat],
                        },
                        properties: {
                            id: String(new Date().getTime()),
                        },
                    }
                    jsonPoint.features.push(point)
                    map.getSource('points' + layerId).setData(jsonPoint)
                    addMeasureRes(jsonPoint)
                }
            }

            /**
             * 添加dom
             * @param {*} jsonPoint 点集
             */
            function addMeasureRes(jsonPoint) {
                if (jsonPoint.features.length > 0) {
                    removedom()
                    const pointList = []
                    for (let i = 0; i < jsonPoint.features.length; i++) {
                        const coords = jsonPoint.features[i].geometry.coordinates
                        pointList.push(coords)

                        const clear = document.createElement('div')
                        clear.setAttribute('class', `measure-result ${layerId} clear`)
                        clear.onclick = (__e) => {
                            // 全部删除
                            __e.stopPropagation()
                            removeLayer()
                            map.off('mousedown', onmousedown)
                            if (catchMark) {
                                catchMark.remove()
                            }
                        }

                        const element = document.createElement('div')
                        element.setAttribute('class', 'measure-result ' + layerId)
                        const option = {
                            element: element,
                            anchor: 'left',
                            offset: [8, 0],
                        }
                        element.innerHTML =  getGPS(coords)
                        if ((jsonPoint.features.length === i + 1) & !isMeasure) {

                        }
                        element.appendChild(clear)
                        new mapboxgl.Marker(option).setLngLat(coords).addTo(map)
                    }
                }
            }

            /**
             * 计算长度
             * @param {*} coords
             * @returns
             */
            function getGPS(coords) {
                let len = '经度：'+coords[0].toFixed(4)+' 纬度：'+coords[1].toFixed(4);
                // if (len < 1) {
                //     len = Math.round(len * 1000) + '米'
                // } else {
                //     len = len.toFixed(2) + '公里'
                // }
                return len
            }

            /**
             * 移除dom
             */
            function removedom() {
                const dom = document.getElementsByClassName('measure-result ' + layerId)
                const len = dom.length
                if (len) {
                    for (let i = len - 1; i >= 0; i--) {
                        if (dom[i]) dom[i].remove()
                    }
                }
            }

            /**
             * 移除图层
             */
            function removeLayer() {
                jsonPoint.features = []
                map.removeLayer('points' + layerId)
                removedom()
            }

            /**
             * 鼠标move事件
             * @param {} _e
             */
            function mouseMove(_e) {
                if (isMeasure) {
                    map.getCanvas().style.cursor = 'default'
                    var coords = [_e.lngLat.lng, _e.lngLat.lat]
                    const jsonp = {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: coords,
                        },
                    }
                    map.getSource('point-move' + layerId).setData(jsonp)

                    // if (jsonPoint.features.length > 0) {
                    //     const pointList = []
                    //     for (let i = 0; i < jsonPoint.features.length; i++) {
                    //         const coord = jsonPoint.features[i].geometry.coordinates
                    //         pointList.push(coord)
                    //     }
                    //     pointList.push(coords)
                    //     const prev = jsonPoint.features[jsonPoint.features.length - 1]
                    //     const jsonl = {
                    //         type: 'Feature',
                    //         geometry: {
                    //             type: 'LineString',
                    //             coordinates: [prev.geometry.coordinates, coords],
                    //         },
                    //     }
                    //     map.getSource('line-move' + layerId).setData(jsonl)
                    //     ele.innerHTML = getLength(pointList)
                    //     tooltip.setLngLat(coords)
                    // }
                }
            }

            /**
             * 绘制完成
             * @param {*} _e
             */
            function finish(_e) {
                if (isMeasure) {
                    isMeasure = false
                    const coords = [_e.lngLat.lng, _e.lngLat.lat];
                    // removePoint(coords)
                    map.removeLayer('point-move' + layerId)
                    map.getCanvas().style.cursor = 'default'
                    tooltip.remove()
                }
            }

            map.on('click', function (_e) {
                addPointforJSON(_e)
                finish(_e)
            })

            map.on('mousemove', function (_e) {
                mouseMove(_e)
            })
        }

        /**
         * 清除所有测量要素
         */
        clearMeasureAll() {
            const dom = document.getElementsByClassName('measure-result')
            const len = dom.length
            if (len) {
                for (let i = len - 1; i >= 0; i--) {
                    if (dom[i]) dom[i].remove()
                }
            }
            if (this.layerList) {
                for (let i = 0; i < this.layerList.length; i++) {
                    const layerid = this.layerList[i]
                    try {
                        const layerIdList = ['points' + layerid,'point-move' + layerid,'points-area' + layerid,'line' + layerid,'line-move' + layerid,'lineArrow' + layerid,'line-area' + layerid,'line-area-stroke' + layerid]
                        layerIdList.forEach(layer =>
                        {
                            if(this.map.getLayer(layer)){
                                this.map.removeLayer(layer)
                            }
                        });
                    } catch (error) {
                        console.log(error)
                    }
                }
            }
            this.layerList = []

            this.map.doubleClickZoom.enable()
        }
    }

var map = window.map = new mapboxgl.Map({
    container: 'map',
    devtools: true,
    zoom: 12.5,
    center: [-77.01866, 38.888],
    style: 'mapbox://styles/mapbox/streets-v10',
    hash: true
});
   var meatureTool ;
    // 测量距离
  function  measureDistance() {
        // ID可以自定义
        const layerId = String(new Date().getTime())
        if (!meatureTool) {
            meatureTool = new MeatureTool(map)
        }
        meatureTool.measureDistance(layerId)
    }
    // 测量面积
    function measureArea() {
        // ID可以自定义
        const layerId = String(new Date().getTime())
        if (!meatureTool) {
            meatureTool = new MeatureTool(map)
        }
        meatureTool.measureArea(layerId)

    }
    // 测量矩形面积
    function measureAreaRect() {
        // ID可以自定义
        const layerId = String(new Date().getTime())
        if (!meatureTool) {
            meatureTool = new MeatureTool(map)
        }
        meatureTool.measureAreaRect(layerId)

    }

    // 测量方位角
    function measureAzimuth() {
        // ID可以自定义
        const layerId = String(new Date().getTime())
        if (!meatureTool) {
            meatureTool = new MeatureTool(map)
        }
        meatureTool.measureAzimuth(layerId)

    }
    // 测量角度量测
    function measureAngle() {
        // ID可以自定义
        const layerId = String(new Date().getTime())
        if (!meatureTool) {
            meatureTool = new MeatureTool(map)
        }
        meatureTool.measureAngle(layerId)

    }

    // 坐标测量
    function measureGPS() {
        // ID可以自定义
        const layerId = String(new Date().getTime())
        if (!meatureTool) {
            meatureTool = new MeatureTool(map)
        }
        meatureTool.measureGPS(layerId)

    }
    // 清除测量结果
    function clearAll() {
        if (meatureTool) {
            meatureTool.clearMeasureAll()
        }
    }


</script>
</body>
</html>
