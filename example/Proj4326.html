<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加载4326瓦片数据</title>

    <script src='../dist/mapbox-gl-dev.js'></script>
    <script type="text/javascript" src="./lib/openlayerTileLayer.js"></script>
    <script type="text/javascript" src="./lib/ol.js"></script>
    <script src='../debug/access_token_generated.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    (function(){
        var map = window.mapboxmap =new mapboxgl.Map({
            container: 'map',
            // projection: 'globe',
            center:[116.47603366376346, 39.923537083352755],
            zoom:10,
            style: 'mapbox://styles/mapbox/satellite-streets-v11',
            // style:{
            //     "version": 8,
            //     "name": "Positron",
            //     "metadata": {},
            //     "glyphs": "fonts/{fontstack}/{range}.pbf",
            //     "sources": {},
            //     "layers": [],
            //     "transition": {
            //         "duration": 0,
            //         "delay": 0
            //     }
            // }
        });

        map.on("load",function(){
            map.addSource("point",{
                type:"geojson",
                data:{
                    type:"FeatureCollection",
                    features:[
                        {
                            "type":"Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates": [116.47603366376346, 39.923537083352755]
                            },
                            "properties": {
                                "title": "Mapbox DC",
                                "marker-symbol": "monument"
                            }
                        }
                    ]
                }
            });

            // var tileGrid = new ol.tilegrid.TileGrid({
            // 	extent:[-180,-90,180,90],
            // 	origin:[-180,90],
            // 	resolutions:[
            // 		1.40625,
            // 		0.703125,
            // 		0.3515625,
            // 		0.17578125,
            // 		0.087890625,
            // 		0.0439453125,
            // 		0.02197265625,
            // 		0.010986328125,
            // 		0.0054931640625,
            // 		0.00274658203125,
            // 		 0.001373291015625,
            // 		 0.0006866455078125,
            // 		 0.00034332275390625,
            // 		 0.000171661376953125,
            // 		 0.0000858306884765625,
            // 		 0.00004291534423828125,
            // 		 0.000021457672119140625,
            // 		 0.000010728836059570312,
            // 		 0.000005364418029785156,
            // 		 0.000002682209014892578,
            // 		 0.000001341104507446289
            // 	]
            // });

            var tileLayer = window.tileLayer = new OpenlayerTileLayer({
                id:"oltileLayer",
                width:4000,
                height:2000,
                tileOptions:{
                    crossOrigin:"anonymous",
                    projection:"EPSG:4326",
                    // url:"http://t1.tianditu.com/vec_c/wmts?layer=vec&style=default&tilematrixset=c&Service=WMTS&Request=GetTile&Version=1.0.0&Format=tiles&TileMatrix={z}&TileCol={x}&TileRow={y}&tk=7e0424e80b3e544a67cd8a30de5e34ec",
                    url:"https://engine.piesat.cn/tile-server/v1?Layer=testidata&TILEMATRIX={z}&TILECOL={x}&TILEROW={y}",
                    // url:'https://t4.tianditu.gov.cn/img_c/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=c&FORMAT=tiles&TILECOL={x}&TILEROW={y}&TILEMATRIX={z}&tk=26049619cf625385e5d593271fc5b895',
                    tileLoadFunction: function(imageTile, src) {
                        {
                            var match = src.match(/TILEMATRIX=(\d+)/);
                            if (match) {
                                var originalX = parseInt(match[1], 10);
                                var newZ = originalX -1;  // 将 x 值加 1

                                // 替换 URL 中的 x 值
                                var modifiedSrc = src.replace(/TILEMATRIX=\d+/, 'TILEMATRIX=' + newZ);
                                imageTile.getImage().src = modifiedSrc;
                            } else {
                                // 如果没有匹配到 x 值，使用原始 src
                                imageTile.getImage().src = src;
                            }
                        }
                    }
                }
            }).addToMap(map);


            map.addLayer({
                id:"test",
                source:"point",
                type:"circle",
                layout:{},
                paint:{
                    "circle-radius":20,
                    "circle-color":"red"
                }
            })

        });

    })();
</script>
</body>
</html>
