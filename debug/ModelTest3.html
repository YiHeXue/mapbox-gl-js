<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beijing Tiananmen Radar Station</title>

    <script src='../dist/mapbox-gl-dev.js'></script>
    <script src='../debug/access_token_generated.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    // mapboxgl.accessToken = 'YOUR_MAPBOX_ACCESS_TOKEN'; // 替换为你的 Mapbox access token

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-streets-v11', // 使用卫星图以更好地展示地理位置
        center: [116.3912, 39.9055], // 北京天安门坐标
        zoom: 15, // 放大到合适的级别
        pitch: 60, // 添加一些倾斜以更好地观察3D效果
        bearing: -60 // 略微旋转地图以获得更好的视角
    });

    class RadarLayer {
        constructor(id, options = {}) {
            this.id = id;
            this.type = 'custom';
            this.renderingMode = '3d';
            this.options = Object.assign({
                radius: 200, // 增大雷达半径
                color: 0x00ff00,
                segments: 64,
                location: [116.3912, 39.9055] // 北京天安门坐标
            }, options);
        }

        onAdd(map, gl) {
            this.map = map;
            this.gl = gl;

            try {
                this.scene = new THREE.Scene();
                this.camera = new THREE.Camera();
                this.renderer = new THREE.WebGLRenderer({
                    canvas: map.getCanvas(),
                    context: gl,
                    antialias: true,
                    alpha: true,
                    premultipliedAlpha: false,
                    preserveDrawingBuffer: true,
                });

                this.renderer.autoClear = false;
                this.renderer.setPixelRatio(window.devicePixelRatio);

                const geometry = new THREE.CircleGeometry(this.options.radius, this.options.segments);
                const material = new THREE.ShaderMaterial({
                    uniforms: {
                        time: { value: 0 },
                        color: { value: new THREE.Color(this.options.color) }
                    },
                    vertexShader: `
                            varying vec2 vUv;
                            void main() {
                                vUv = uv;
                                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                            }
                        `,
                    fragmentShader: `
                            uniform float time;
                            uniform vec3 color;
                            varying vec2 vUv;
                            void main() {
                                float angle = atan(vUv.y - 0.5, vUv.x - 0.5);
                                float normAngle = (angle + 3.14159) / (2.0 * 3.14159);
                                float scanAngle = mod(time * 0.5, 1.0);
                                float alpha = 1.0 - step(0.02, abs(normAngle - scanAngle));
                                gl_FragColor = vec4(color, alpha * 0.5);
                            }
                        `,
                    transparent: true,
                    side: THREE.DoubleSide
                });

                this.radar = new THREE.Mesh(geometry, material);
                this.radar.rotation.x = -Math.PI / 2;
                this.scene.add(this.radar);

                console.log('Three.js scene initialized successfully');
            } catch (error) {
                console.error('Error initializing Three.js scene:', error);
            }
        }

        render(gl, matrix) {
            if (!this.renderer) {
                console.warn('Renderer not initialized');
                return;
            }

            const rotationX = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(1, 0, 0), Math.PI / 2);
            const rotationZ = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(0, 0, 1), this.map.getBearing() * Math.PI / 180);
            const m = new THREE.Matrix4().fromArray(matrix);
            const l = new THREE.Matrix4().makeTranslation(0, 0, 0).scale(new THREE.Vector3(1, -1, 1));

            this.camera.projectionMatrix.copy(m.multiply(l).multiply(rotationX).multiply(rotationZ));

            const currentViewport = gl.getParameter(gl.VIEWPORT);

            try {
                this.renderer.resetState();
                this.renderer.setViewport(
                    currentViewport[0],
                    currentViewport[1],
                    currentViewport[2],
                    currentViewport[3]
                );
                this.renderer.render(this.scene, this.camera);

                this.radar.material.uniforms.time.value += 0.01;
            } catch (error) {
                console.error('Error rendering Three.js scene:', error);
            }

            this.map.triggerRepaint();
        }

        // 新增方法：更新雷达位置
        setLocation(lngLat) {
            const pos = mapboxgl.MercatorCoordinate.fromLngLat(lngLat, 0);
            this.radar.position.set(pos.x, pos.y, pos.z);
        }
    }

    map.on('load', () => {
        try {
            const radarLayer = new RadarLayer('radar', {
                radius: 200,
                color: 0x00ff00,
                segments: 64,
                location: [116.3912, 39.9055] // 北京天安门坐标
            });
            map.addLayer(radarLayer);
            console.log('Radar layer added successfully');

            // 设置雷达位置
            radarLayer.setLocation(radarLayer.options.location);

            // 添加一个标记点来表示雷达站位置
            new mapboxgl.Marker()
                .setLngLat(radarLayer.options.location)
                .addTo(map);

        } catch (error) {
            console.error('Error adding radar layer:', error);
        }
    });

    // 添加一些调试信息
    map.on('error', (e) => {
        console.error('Mapbox GL JS error:', e);
    });

    window.addEventListener('error', (e) => {
        console.error('Global error:', e.error);
    });
</script>
</body>
</html>
